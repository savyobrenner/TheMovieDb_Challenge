//
//  FavoritesScreenPresenter.swift
//  VeryCreatives
//
//  Created by Brenner on 06/09/21.
//
//  This file was generated by the ðŸ’š VIPER generator.
//

import UIKit

final class FavoritesScreenPresenter {
    
    // MARK: - Private properties
    
    private weak var view: FavoritesScreenViewInterface?
    private let interactor: FavoritesScreenInteractorProtocol
    private let wireframe: FavoritesScreenWireframeInterface
        
    private enum Strings {
        static let cellIdentifier = "MovieCell"
        static let title = FavoritesScreenViewControllerStrings.title.localized()
        static let emptyStateText = FavoritesScreenViewControllerStrings.emptyStateText.localized()
    }
    
    private enum Constants {
        static let iconBordWidth: CGFloat = 1.0
        static let widthCompensation: CGFloat = 20.0
        static let widthDivisionFactor: CGFloat = 2.0
        static let heightDivisionFactor:CGFloat = 3.0
    }
    
    private var movies: [FavoriteMovie]? {
        didSet {
            view?.reloadData()
            view?.showLoading(hide: true)
        }
    }
    // MARK: - Lifecycle
    
    init(wireframe: FavoritesScreenWireframeInterface, view: FavoritesScreenViewInterface, interactor: FavoritesScreenInteractorProtocol) {
        self.wireframe = wireframe
        self.view = view
        self.interactor = interactor
    }
    
    func viewDidAppear(animated: Bool) {
        view?.updateEmptyView(hasFavorites(), text: Strings.emptyStateText)
    }
    
    func viewDidLoad() {
        view?.showLoading(hide: false)
    }
    
    private func configureIcon(_ imageView: UIImageView) {
        imageView.layer.borderColor = UIColor.white.cgColor
        imageView.layer.borderWidth = Constants.iconBordWidth
        imageView.circle()
    }
    
    private func hasFavorites() -> Bool {
        if let favorites = UserDefaults.standard.getMovieDetailsObject(), !favorites.isEmpty {
            self.movies = favorites
            return true
        }
        return false
    }
}

// MARK: - Extensions

extension FavoritesScreenPresenter: FavoritesScreenPresenterInterface {
    func configure(_ collectionView: UICollectionView) {
        let nib = UINib(nibName: Strings.cellIdentifier, bundle: nil)
        collectionView.register(nib, forCellWithReuseIdentifier: Strings.cellIdentifier)
    }
    
    func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        guard let favoriteMovie = movies?[indexPath.row] else { return }
        wireframe.navigate(to: .goToMovieDetail(favoriteMovie: favoriteMovie))
    }
    
    func numberOfItemsInSection(_ collectionView: UICollectionView, section: Int) -> Int {
        return movies?.count ?? 0
    }
    
    func cellForItemAt(_ collectionView: UICollectionView, indexPath: IndexPath) -> UICollectionViewCell {
        guard let cell = collectionView.dequeueReusableCell(withReuseIdentifier: Strings.cellIdentifier, for: indexPath) as? MovieCell else {
            return UICollectionViewCell()
        }
        let movie = movies?[indexPath.row].movieDetails
        cell.setup(movie: movie)
        
        return cell
    }
    
    func collectionView(_ collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAt indexPath: IndexPath) -> CGSize {
        // Define cell width
        let screenWidth = UIScreen.main.bounds.width
        let widthDesired = CGFloat(screenWidth / Constants.widthDivisionFactor - Constants.widthCompensation)
        
        // Define cell height
        let screenHeight = UIScreen.main.bounds.height
        let heightDesired = CGFloat(screenHeight / Constants.heightDivisionFactor)
        
        return CGSize(width: widthDesired, height: heightDesired)
    }
    
    func setupFavoritesHeader(_ title: UILabel, _ icon: UIImageView) {
        configureIcon(icon)
        title.text = Strings.title
    }
}
